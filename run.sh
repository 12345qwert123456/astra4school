#!/bin/bash

# ===================================
# –£–°–¢–ê–ù–û–í–û–ß–ù–´–ô –°–ö–†–ò–ü–¢-–ó–ê–ì–†–£–ó–ß–ò–ö
# ===================================
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –∫–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å Git –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É
# —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.
# –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫–æ–ª–ª–µ–≥–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª + .env

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "======================================="
echo "   –ó–ê–ì–†–£–ó–ö–ê –£–°–¢–ê–ù–û–í–û–ß–ù–û–ì–û –°–ö–†–ò–ü–¢–ê"
echo "======================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo bash run.sh"
    exit 1
fi

echo "‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã"
echo ""

# –í—ã–±–æ—Ä —Ç–∏–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
echo "1) –ü–ö —É—á–∏—Ç–µ–ª—è (—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ü–û)"
echo "2) –ü–ö —É—á–µ–Ω–∏–∫–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞)"
echo ""
read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1 –∏–ª–∏ 2): " INSTALL_TYPE

case $INSTALL_TYPE in
    1)
        INSTALL_MODE="teacher"
        echo -e "${GREEN}‚úì${NC} –í—ã–±—Ä–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –ü–ö —É—á–∏—Ç–µ–ª—è"
        ;;
    2)
        INSTALL_MODE="student"
        echo -e "${GREEN}‚úì${NC} –í—ã–±—Ä–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –ü–ö —É—á–µ–Ω–∏–∫–∞"
        ;;
    *)
        echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–ü–ö —É—á–µ–Ω–∏–∫–∞)${NC}"
        INSTALL_MODE="student"
        ;;
esac
echo ""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∫—Ä–∏–ø—Ç
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dos2unix –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏–π —Å—Ç—Ä–æ–∫)
if ! command -v dos2unix &> /dev/null; then
    echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dos2unix...${NC}"
    apt update > /dev/null 2>&1
    apt install dos2unix -y > /dev/null 2>&1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ .env –∏–∑ Windows –≤ Unix —Ñ–æ—Ä–º–∞—Ç (CRLF -> LF)
if [ -f "$SCRIPT_DIR/.env" ]; then
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ dos2unix
    if command -v dos2unix &> /dev/null; then
        dos2unix "$SCRIPT_DIR/.env" 2>/dev/null
    else
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è \r
        sed -i 's/\r$//' "$SCRIPT_DIR/.env" 2>/dev/null
    fi
fi

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f "$SCRIPT_DIR/.env" ]; then
    source "$SCRIPT_DIR/.env"
else
    echo -e "${RED}‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo "–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º: $SCRIPT_DIR"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
if [ -z "$GIT_USERNAME" ] || [ -z "$GIT_REPO" ]; then
    echo -e "${RED}‚ùå –í —Ñ–∞–π–ª–µ .env –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç GIT_USERNAME –∏–ª–∏ GIT_REPO!${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GitHub
echo -ne "${YELLOW}[/]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub...\033[K"
if ping -c 1 -W 2 github.com > /dev/null 2>&1 || ping -c 1 -W 2 8.8.8.8 > /dev/null 2>&1; then
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ GitHub —á–µ—Ä–µ–∑ curl –∏–ª–∏ wget
    if command -v curl &> /dev/null; then
        if curl -s --connect-timeout 5 https://github.com > /dev/null 2>&1; then
            echo -e "\r${GREEN}[+]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub - ${GREEN}–£–°–ü–ï–®–ù–û${NC}\033[K"
        else
            echo -e "\r${RED}[-]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub - ${RED}–ù–ï–î–û–°–¢–£–ü–ï–ù${NC}\033[K"
            echo -e "${RED}GitHub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏.${NC}"
            exit 1
        fi
    elif command -v wget &> /dev/null; then
        if wget -q --timeout=5 --spider https://github.com 2>&1; then
            echo -e "\r${GREEN}[+]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub - ${GREEN}–£–°–ü–ï–®–ù–û${NC}\033[K"
        else
            echo -e "\r${RED}[-]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub - ${RED}–ù–ï–î–û–°–¢–£–ü–ï–ù${NC}\033[K"
            echo -e "${RED}GitHub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏.${NC}"
            exit 1
        fi
    else
        echo -e "\r${GREEN}[+]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub - ${GREEN}–ü–†–û–ü–£–©–ï–ù–û${NC}\033[K"
    fi
else
    echo -e "\r${RED}[-]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub - ${RED}–ù–ï–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø${NC}\033[K"
    echo -e "${RED}–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.${NC}"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v git &> /dev/null; then
    echo -e "${YELLOW}üì¶ Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git...${NC}"
    apt update > /dev/null 2>&1
    if apt install git -y > /dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ Git —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    else
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Git${NC}"
        echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é: apt install git"
        exit 1
    fi
else
    echo -e "${GREEN}‚úÖ Git —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
fi

# URL Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
GIT_REPO_URL="https://github.com/${GIT_USERNAME}/${GIT_REPO}.git"

# –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
TEMP_DIR="/tmp/astra-setup"

echo -e "${YELLOW}üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–∑ Git...${NC}"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -d "$TEMP_DIR" ]; then
    rm -rf "$TEMP_DIR"
fi

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
if git clone --depth 1 "$GIT_REPO_URL" "$TEMP_DIR" 2>&1 | grep -v "Cloning into"; then
    echo -e "${GREEN}‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω${NC}"
    
    # –ö–æ–ø–∏—Ä—É–µ–º .env –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    cp "$SCRIPT_DIR/.env" "$TEMP_DIR/.env"
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    cd "$TEMP_DIR" || exit 1
    
    echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏...${NC}"
    echo ""
    
    # –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ç–∏–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    bash ./setup-main.sh "$INSTALL_MODE"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞
    EXIT_CODE=$?
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ
    cd ..
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    rm -rf "$TEMP_DIR"
    
    exit $EXIT_CODE
    
else
    echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π${NC}"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    echo "1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
    echo "2. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ git (apt install git)"
    echo "3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ —Å–∫—Ä–∏–ø—Ç–µ"
    echo "4. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    rm -rf "$TEMP_DIR"
    exit 1
fi
